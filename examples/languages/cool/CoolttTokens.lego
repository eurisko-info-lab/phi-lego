-----------------------------------------------------
-- CoolttTokens: Tokenizer specification for cooltt
--
-- Extracted from: vendor/cooltt/src/frontend/Lex.mll
-- 
-- This defines the lexical structure of cooltt including:
-- - Keywords and commands
-- - Operators and delimiters
-- - Unicode alternatives (emoji support!)
-- - Comment syntax
-- - Identifier rules
-----------------------------------------------------

import Cooltt

-----------------------------------------------------
-- Token Categories
-----------------------------------------------------

vocab CoolttTokens
  -- Structural tokens
  "(" ")" "[" "]" "{" "}" "{!" "!}"
  ":" ";" ";;" "," "." "|"
  
  -- Operators
  "Ã—" "*" "â­" "ğŸŒŸ"        -- Times (product)
  "âˆ·" "::"                  -- Cons/path separator
  "âˆ§" "/\\"                 -- Meet (conjunction)
  "âˆ¨" "\\/"                 -- Join (disjunction)
  "=" "=["  "=[]"           -- Equality, equation steps
  "<=" "â‰¤"                  -- Less-than-or-equal
  "â‰”" ":="                  -- Definition
  "::="                     -- Field definition
  "â†’" "->"                  -- Arrow (function type)
  "â†" "<-"                  -- Left arrow (abstract)
  "â‡’" "=>"                  -- Double arrow (lambda)
  "_"                       -- Underscore/wildcard
  "#"                       -- Hash (patch)
  "!"                       -- Bang

-----------------------------------------------------
-- Commands (prefixed with #)
-----------------------------------------------------

vocab Commands
  "#fail"                   -- Expect failure
  "#normalize"              -- Normalize term
  "#print"                  -- Print definition
  "#debug"                  -- Toggle debug mode
  "#viz"                    -- Visualize
  "#quit"                   -- Exit

-----------------------------------------------------
-- Keywords with Unicode Alternatives
-----------------------------------------------------

vocab Keywords
  -- Natural numbers
  "zero" "suc" "nat" "ğŸ”¢"
  
  -- Circle
  "base" "loop" "â°" "circle" "ğŸª"
  
  -- Records
  "sig" "âœ" "struct" "ğŸ±" "include" "renaming" "open" "as"
  
  -- Core
  "let" "in" "fst" "snd" "elim" "generalize"
  
  -- Definitions
  "def" "abstract" "ğŸ“Œ" "axiom" "ğŸ›"
  
  -- Types
  "type"
  "ğ•€" "dim"                 -- Interval
  "ğ”½" "cof"                 -- Cofibration
  "sub" "ext"               -- Sub and extension types
  
  -- Cubical operations
  "coe" "hcom" "hfill" "com"
  
  -- V types
  "V" "ğŸ¥¦" "vproj" "cap"
  
  -- Module keywords
  "with" "import" "unfold" "ğŸ“¥"
  "begin" "â–¶ï¸" "end" "â¹ï¸" "equation"
  "section" "shadowing" "ğŸ“¦"
  "view" "ğŸ‘ï¸" "ğŸ‘€" "ğŸ‘“" "ğŸ•¶ï¸"
  "repack" "ğŸ" "ğŸ§§"
  "export" "ğŸ“¤"
  "on" "off"

-----------------------------------------------------
-- Logical Constants
-----------------------------------------------------

vocab LogicalConstants
  "true" "âŠ¤"                -- Top (true cofibration)
  "false" "âŠ¥"               -- Bot (false cofibration)
  "âˆ‚"                       -- Boundary operator

-----------------------------------------------------
-- Holes
-----------------------------------------------------

vocab HoleTokens
  "?"                       -- Anonymous hole
  "?_"                      -- Silent hole prefix

-----------------------------------------------------
-- Lexical Rules
-----------------------------------------------------

piece LexicalRules
  -- Whitespace
  whitespace ::= [ \t]+
  lineending ::= \r | \n | \r\n
  
  -- Comments
  linecomment ::= ("--" | "â" | "ğŸ“") [^\n\r]* lineending
  blockcomment ::= "/-" blockinner "-/"
  blockinner ::= ([^-/] | "-" [^/] | "/" [^-] | blockcomment)*
  
  -- Numbers
  numeral ::= [0-9]+
  
  -- Identifiers
  -- atom_initial: not digit, dash, special chars
  -- atom_subsequent: not parens, brackets, special punctuation
  atominitial ::= [^0-9\-?!()[\]{}<>.#\\@*^:,;|=" \t\n\r]
  atomsubsequent ::= [^()[\]{}<>.#\\@*^:,;|=" \t\n\r]
  atom ::= atominitial atomsubsequent*
  
  -- Holes with names
  holeatom ::= "?" atomsubsequent*
  silentholeaom ::= "?_" atomsubsequent*
  
  -- Module paths (for import)
  modulepart ::= [^/?!()[\]{}<>.\\ *:,;|=" \t\n\r]+

-----------------------------------------------------
-- Token Mapping (Lex.mll transcription)
-----------------------------------------------------

piece TokenMapping
  -- Numbers
  rule numeral: numeral -> NUMERAL
  
  -- Terminators
  rule semisemi: "â¨¾" | ";;" | "ğŸ›‘" -> SEMISEMI
  
  -- Delimiters
  rule lparen: "(" -> LPR
  rule rparen: ")" -> RPR
  rule lbrace: "{" -> LBR
  rule rbrace: "}" -> RBR
  rule lsquare: "[" -> LSQ
  rule rsquare: "]" -> RSQ
  rule lbang: "{!" -> LBANG
  rule rbang: "!}" -> RBANG
  
  -- Punctuation
  rule pipe: "|" -> PIPE
  rule hash: "#" -> HASH
  rule comma: "," -> COMMA
  rule dot: "." -> DOT
  rule semi: ";" -> SEMI
  
  -- Operators
  rule times: "Ã—" | "*" | "â­" | "ğŸŒŸ" -> TIMES
  rule colon: ":" -> COLON
  rule coloncolon: "âˆ·" | "::" -> COLON_COLON
  rule meet: "âˆ§" | "/\\" -> MEET
  rule join: "âˆ¨" | "\\/" -> JOIN
  rule equals: "=" -> EQUALS
  rule eqsq: "=[" -> LSQEQUALS
  rule eqsqsq: "=[]" -> LRSQEQUALS
  rule lessthan: "<=" | "â‰¤" -> LESS_THAN
  rule coloneq: "â‰”" | ":=" -> COLON_EQUALS
  rule coloncoloneq: "::=" -> COLON_COLON_EQUALS
  rule arrow: "â†’" | "->" -> RIGHT_ARROW
  rule leftarrow: "â†" | "<-" -> LEFT_ARROW
  rule doublearrow: "â‡’" | "=>" -> RRIGHT_ARROW
  rule underscore: "_" -> UNDERSCORE
  rule bang: "!" -> BANG
  rule boundary: "âˆ‚" -> BOUNDARY
  
  -- Logical constants
  rule topc: "true" | "âŠ¤" -> TOPC
  rule botc: "false" | "âŠ¥" -> BOTC
  
  -- Holes
  rule silenthole: "?_" holeatom? -> HOLE_SILENT
  rule hole: "?" holeatom? -> HOLE
  
  -- Keywords (matched from keyword table)
  rule keyword: atom -> lookup keyword_table
  
  -- Default: atom is identifier
  rule ident: atom -> ATOM

-----------------------------------------------------
-- Keyword Table
-----------------------------------------------------

piece KeywordTable
  keyword_table :=
    "zero"       => ZERO
    "suc"        => SUC
    "nat"        => NAT
    "ğŸ”¢"         => NAT
    "base"       => BASE
    "loop"       => LOOP
    "â°"         => LOOP
    "circle"     => CIRCLE
    "ğŸª"         => CIRCLE
    "sig"        => SIG
    "âœ"         => SIG
    "struct"     => STRUCT
    "ğŸ±"         => STRUCT
    "include"    => INCLUDE
    "renaming"   => RENAMING
    "open"       => OPEN
    "as"         => AS
    "let"        => LET
    "in"         => IN
    "fst"        => FST
    "snd"        => SND
    "elim"       => ELIM
    "generalize" => GENERALIZE
    "def"        => DEF
    "abstract"   => ABSTRACT
    "ğŸ“Œ"         => DEF
    "axiom"      => AXIOM
    "ğŸ›"         => AXIOM
    "type"       => TYPE
    "ğ•€"          => DIM
    "dim"        => DIM
    "ğ”½"          => COF
    "cof"        => COF
    "sub"        => SUB
    "ext"        => EXT
    "coe"        => COE
    "hcom"       => HCOM
    "hfill"      => HFILL
    "com"        => COM
    "V"          => V
    "ğŸ¥¦"         => V
    "vproj"      => VPROJ
    "cap"        => CAP
    "with"       => WITH
    "import"     => IMPORT
    "unfold"     => UNFOLD
    "ğŸ“¥"         => IMPORT
    "begin"      => BEGIN
    "â–¶ï¸"         => BEGIN
    "end"        => END
    "â¹ï¸"         => END
    "equation"   => EQUATION
    "section"    => SECTION
    "shadowing"  => SHADOWING
    "ğŸ“¦"         => SECTION
    "view"       => VIEW
    "ğŸ‘ï¸"         => VIEW
    "ğŸ‘€"         => VIEW
    "ğŸ‘“"         => VIEW
    "ğŸ•¶ï¸"         => VIEW
    "repack"     => REPACK
    "ğŸ"         => REPACK
    "ğŸ§§"         => REPACK
    "export"     => EXPORT
    "ğŸ“¤"         => EXPORT
    "on"         => ON
    "off"        => OFF

-----------------------------------------------------
-- Command Table
-----------------------------------------------------

piece CommandTable
  command_table :=
    "#fail"      => FAIL
    "#normalize" => NORMALIZE
    "#print"     => PRINT
    "#debug"     => DEBUG
    "#viz"       => VISUALIZE
    "#quit"      => QUIT

-----------------------------------------------------
-- Tests
-----------------------------------------------------

piece Tests
  -- Keywords
  test token "nat": nat -> NAT
  test token "ğŸ”¢": ğŸ”¢ -> NAT
  test token "circle": circle -> CIRCLE
  test token "ğŸª": ğŸª -> CIRCLE
  test token "def": def -> DEF
  test token "ğŸ“Œ": ğŸ“Œ -> DEF
  
  -- Operators
  test token "->": -> -> RIGHT_ARROW
  test token "â†’": â†’ -> RIGHT_ARROW
  test token "=>": => -> RRIGHT_ARROW
  test token "â‡’": â‡’ -> RRIGHT_ARROW
  test token "*": * -> TIMES
  test token "Ã—": Ã— -> TIMES
  test token "/\\": /\\ -> MEET
  test token "âˆ§": âˆ§ -> MEET
  test token "\\/": \\/ -> JOIN
  test token "âˆ¨": âˆ¨ -> JOIN
  
  -- Holes
  test token "?": ? -> HOLE
  test token "?foo": ?foo -> HOLE("foo")
  test token "?_": ?_ -> HOLE_SILENT
  test token "?_bar": ?_bar -> HOLE_SILENT("bar")
  
  -- Numbers
  test token "0": 0 -> NUMERAL(0)
  test token "42": 42 -> NUMERAL(42)
  test token "100": 100 -> NUMERAL(100)
  
  -- Identifiers
  test token "x": x -> ATOM("x")
  test token "foo": foo -> ATOM("foo")
  test token "foo-bar": foo-bar -> ATOM("foo-bar")
  test token "x'": x' -> ATOM("x'")
  
  -- Comments (should be skipped)
  test skip "-- comment\n": -- comment
  test skip "â APL comment\n": â APL comment
  test skip "ğŸ“ note\n": ğŸ“ note
  test skip "/- block -/": /- block comment -/
  test skip "/- nested /- block -/ -/": /- outer /- inner -/ -/

